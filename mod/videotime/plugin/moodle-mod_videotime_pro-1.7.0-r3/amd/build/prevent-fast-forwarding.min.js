define("videotimeplugin_pro/prevent-fast-forwarding",["exports","mod_videotime/videotime-plugin","core/ajax","core/config","core/notification","core/log","core/str"],(function(_exports,_videotimePlugin,_ajax,_config,_notification,_log,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_videotimePlugin=_interopRequireDefault(_videotimePlugin),_ajax=_interopRequireDefault(_ajax),_config=_interopRequireDefault(_config),_notification=_interopRequireDefault(_notification),_log=_interopRequireDefault(_log);class PreventFastForwarding extends _videotimePlugin.default{constructor(){super("preventfastforwarding"),this.watchTime=0,this.seeking=!1,this.duration=0,this.playbackRate=1,this.fastForwardBuffer=2.5,this.lastNotice=0}initialize(videotime,instance){Number(instance.preventfastforwarding)?(this.getWatchPercent(videotime.getCmId(),instance.token).then((percent=>{videotime.getDuration().then((duration=>{Number.isNaN(duration)||!duration?videotime.getPlayer().on("play",(()=>{videotime.getDuration().then((duration=>{this.duration=duration,this.watchTime=percent*duration,_log.default.debug("PREVENT FF: watch time "+this.watchTime)})).catch(_notification.default.exception)})):(this.duration=duration,this.watchTime=percent*duration,_log.default.debug("PREVENT FF: watch time "+this.watchTime))})).catch(_notification.default.exception)})).catch(_notification.default.exception),videotime.getPlaybackRate().then((playbackRate=>{this.playbackRate=playbackRate})),videotime.getPlayer().on("playbackrateschange",(data=>{this.playbackRate=data.playbackRate})),videotime.getPlayer().on("playbackratechange",(data=>{this.playbackRate=data.playbackRate})),videotime.getPlayer().on("timeupdate",(()=>{setTimeout((()=>{videotime.getCurrentPosition().then((seconds=>{this.duration&&seconds>this.watchTime+this.fastForwardBuffer*this.playbackRate?(_log.default.debug("PREVENT FF: Preventing..."),videotime.setCurrentPosition(this.watchTime),Date.now()>this.lastNotice+5e3&&(this.lastNotice=Date.now(),(0,_str.get_string)("preventfastforwardingmessage","mod_videotime",{percent:Math.round(100*this.watchTime/this.duration)}).then(this.message).fail(_notification.default.exception))):seconds>this.watchTime&&(this.watchTime=seconds,_log.default.debug("PREVENT FF: setting watch time "+seconds))}))}))})),super.initialize(videotime)):super.initialize(videotime)}message(message){_notification.default.addNotification({message:message,type:"info"})}getWatchPercent(cmId,token){if(token){const url=new URL(_config.default.wwwroot+"/webservice/rest/server.php"),data=url.searchParams;return data.set("wstoken",token),data.set("moodlewsrestformat","json"),data.set("wsfunction","videotimeplugin_pro_get_watch_percent"),data.set("cmid",cmId),fetch(url).then((response=>(response.ok||_notification.default.exeption("Web service error"),response.json())))}return _ajax.default.call([{methodname:"videotimeplugin_pro_get_watch_percent",args:{cmid:cmId}}])[0]}}return _exports.default=PreventFastForwarding,_exports.default}));

//# sourceMappingURL=prevent-fast-forwarding.min.js.map